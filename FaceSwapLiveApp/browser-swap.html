<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Browser Face Swap</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background: #000;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
            overflow: hidden;
            height: 100vh;
            height: 100dvh;
            -webkit-user-select: none;
            user-select: none;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
        }

        .video-wrapper {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #000;
        }

        video {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover;
            display: none;
        }

        #canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover;
        }

        .top-bar {
            position: absolute;
            top: 0; left: 0; right: 0;
            padding: max(env(safe-area-inset-top, 12px), 12px) 16px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .top-bar-group {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .pill-btn {
            height: 40px;
            border-radius: 20px;
            background: rgba(255,255,255,0.12);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border: none;
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 0 14px;
            gap: 6px;
            transition: transform 0.12s ease;
        }

        .pill-btn:active { transform: scale(0.92); }

        .icon-btn {
            width: 40px; height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.12);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border: none;
            color: #fff;
            font-size: 17px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.12s ease;
        }

        .icon-btn:active { transform: scale(0.88); }

        .status-pill {
            position: absolute;
            top: calc(max(env(safe-area-inset-top, 44px), 44px) + 52px);
            left: 50%;
            transform: translateX(-50%);
            padding: 6px 16px;
            background: rgba(0,0,0,0.55);
            -webkit-backdrop-filter: blur(16px);
            backdrop-filter: blur(16px);
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            color: rgba(255,255,255,0.8);
            z-index: 10;
            transition: opacity 0.3s ease;
            white-space: nowrap;
        }

        .select-prompt {
            position: absolute;
            bottom: 130px;
            left: 50%;
            transform: translateX(-50%);
            padding: 14px 24px;
            background: rgba(255,255,255,0.14);
            -webkit-backdrop-filter: blur(24px);
            backdrop-filter: blur(24px);
            border-radius: 28px;
            font-size: 15px;
            font-weight: 600;
            color: #fff;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: transform 0.15s ease;
            border: none;
        }

        .select-prompt:active { transform: translateX(-50%) scale(0.95); }

        .bottom-bar {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            padding: 16px 20px calc(max(env(safe-area-inset-bottom, 20px), 20px) + 8px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 10;
        }

        .face-thumb {
            width: 50px; height: 50px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid rgba(255,255,255,0.35);
            background: rgba(255,255,255,0.08);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .face-thumb img {
            width: 100%; height: 100%;
            object-fit: cover;
            display: none;
        }

        .face-thumb svg { opacity: 0.6; }

        .capture-ring {
            width: 74px; height: 74px;
            border-radius: 50%;
            border: 4px solid #fff;
            background: transparent;
            cursor: pointer;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.12s ease;
        }

        .capture-ring:active { transform: scale(0.88); }

        .capture-inner {
            width: 62px; height: 62px;
            border-radius: 50%;
            background: #fff;
        }

        .gallery-thumb {
            width: 50px; height: 50px;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid rgba(255,255,255,0.35);
            background: rgba(255,255,255,0.08);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .gallery-thumb img {
            width: 100%; height: 100%;
            object-fit: cover;
            display: none;
        }

        .gallery-thumb svg { opacity: 0.4; }

        .loading-overlay {
            position: absolute;
            inset: 0;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
            gap: 20px;
            transition: opacity 0.5s ease;
        }

        .loading-overlay.done {
            opacity: 0;
            pointer-events: none;
        }

        .spinner {
            width: 32px; height: 32px;
            border: 3px solid rgba(255,255,255,0.15);
            border-top-color: rgba(255,255,255,0.8);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text {
            font-size: 14px;
            color: rgba(255,255,255,0.5);
            font-weight: 500;
            text-align: center;
            max-width: 260px;
            line-height: 1.4;
        }

        .flash-overlay {
            position: fixed;
            inset: 0;
            background: #fff;
            z-index: 300;
            pointer-events: none;
            animation: flashAnim 0.2s ease-out forwards;
        }

        @keyframes flashAnim { from { opacity: 1; } to { opacity: 0; } }

        .hidden { display: none !important; }
        input[type="file"] { display: none; }
    </style>
</head>
<body>
<div class="container">
    <div class="loading-overlay" id="loader">
        <div class="spinner"></div>
        <div class="loading-text" id="loaderText">Initializing face engine...</div>
    </div>

    <div class="video-wrapper">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="canvas"></canvas>

        <div class="top-bar">
            <div class="top-bar-group">
                <button class="icon-btn hidden" id="clearBtn" aria-label="Clear face">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M4 4l8 8M12 4l-8 8" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
                </button>
            </div>
            <div class="top-bar-group">
                <button class="icon-btn" id="flipBtn" aria-label="Flip camera">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M20 7l-4-4v3H8a4 4 0 000 8h1M4 17l4 4v-3h8a4 4 0 000-8h-1" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
            </div>
        </div>

        <div class="status-pill" id="statusPill" style="opacity:0"></div>

        <button class="select-prompt" id="selectPrompt">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="8" r="4" stroke="#fff" stroke-width="2"/><path d="M4 20c0-3.3 3.6-6 8-6s8 2.7 8 6" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
            <span>Select a Face to Swap</span>
        </button>

        <div class="bottom-bar">
            <div class="face-thumb" id="facePicker">
                <img id="faceImg" />
                <svg id="facePlaceholder" width="24" height="24" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="8" r="3.5" stroke="#fff" stroke-width="1.5"/><path d="M5.5 20c0-2.8 3-5 6.5-5s6.5 2.2 6.5 5" stroke="#fff" stroke-width="1.5" stroke-linecap="round"/><path d="M18 8l2 2M20 8l-2 2" stroke="#fff" stroke-width="1.2" stroke-linecap="round"/></svg>
            </div>

            <div class="capture-ring" id="captureBtn"><div class="capture-inner"></div></div>

            <div class="gallery-thumb" id="galleryBtn">
                <img id="galleryImg" />
                <svg id="galleryPlaceholder" width="22" height="22" viewBox="0 0 24 24" fill="none"><rect x="3" y="5" width="18" height="14" rx="2" stroke="#fff" stroke-width="1.5"/><circle cx="8.5" cy="10.5" r="1.5" stroke="#fff" stroke-width="1.2"/><path d="M3 16l5-4 3 3 4-5 6 7" stroke="#fff" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </div>
        </div>
    </div>
</div>

<input type="file" id="faceInput" accept="image/*" />

<script type="module">
    const { FaceLandmarker, FilesetResolver } = await import(
        'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.22/vision_bundle.mjs'
    );

    const $ = id => document.getElementById(id);
    const video = $('video');
    const canvas = $('canvas');
    const ctx = canvas.getContext('2d');

    let landmarker = null;
    let sourceFaceCanvas = null;
    let swapping = false;
    let facing = 'user';
    let lastTime = -1;
    let lastCapture = null;

    async function boot() {
        try {
            $('loaderText').textContent = 'Loading face detection model...';
            const resolver = await FilesetResolver.forVisionTasks(
                'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.22/wasm'
            );
            landmarker = await FaceLandmarker.createFromOptions(resolver, {
                baseOptions: {
                    modelAssetPath: 'https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task',
                    delegate: 'GPU'
                },
                runningMode: 'VIDEO',
                numFaces: 1,
                minFaceDetectionConfidence: 0.45,
                minFacePresenceConfidence: 0.45,
                minTrackingConfidence: 0.45
            });

            $('loaderText').textContent = 'Starting camera...';
            await openCamera();
            setTimeout(() => $('loader').classList.add('done'), 300);
            tick();
        } catch (e) {
            $('loaderText').textContent = 'Could not load face engine. Check your internet connection.';
            console.error(e);
        }
    }

    async function openCamera() {
        if (video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: facing, width: { ideal: 1280 }, height: { ideal: 720 }, frameRate: { ideal: 30 } },
            audio: false
        });
        video.srcObject = stream;
        await video.play();
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
    }

    function tick() {
        if (!video.paused && !video.ended && video.currentTime !== lastTime) {
            lastTime = video.currentTime;
            if (canvas.width !== video.videoWidth) canvas.width = video.videoWidth;
            if (canvas.height !== video.videoHeight) canvas.height = video.videoHeight;

            ctx.save();
            if (facing === 'user') { ctx.translate(canvas.width, 0); ctx.scale(-1, 1); }
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            ctx.restore();

            let detected = false;
            if (landmarker) {
                try {
                    const res = landmarker.detectForVideo(video, performance.now());
                    if (res.faceLandmarks && res.faceLandmarks.length > 0) {
                        detected = true;
                        if (swapping && sourceFaceCanvas) overlay(res.faceLandmarks[0]);
                    }
                } catch (_) {}
            }

            const pill = $('statusPill');
            if (swapping && !detected) { pill.textContent = 'No face detected'; pill.style.opacity = '1'; }
            else if (swapping) { pill.textContent = 'Swapping'; pill.style.opacity = '1'; }
            else pill.style.opacity = '0';
        }
        requestAnimationFrame(tick);
    }

    function overlay(lms) {
        let x0 = Infinity, y0 = Infinity, x1 = -Infinity, y1 = -Infinity;
        for (const l of lms) {
            const px = (facing === 'user' ? 1 - l.x : l.x) * canvas.width;
            const py = l.y * canvas.height;
            if (px < x0) x0 = px; if (py < y0) y0 = py;
            if (px > x1) x1 = px; if (py > y1) y1 = py;
        }
        const fw = (x1 - x0) * 1.6;
        const fh = (y1 - y0) * 1.6;
        const cx = (x0 + x1) / 2;
        const cy = (y0 + y1) / 2 - (y1 - y0) * 0.03;
        const tw = Math.round(fw);
        const th = Math.round(fh);
        if (tw <= 0 || th <= 0) return;

        const tmp = document.createElement('canvas');
        tmp.width = tw; tmp.height = th;
        const tc = tmp.getContext('2d');
        tc.drawImage(sourceFaceCanvas, 0, 0, tw, th);

        tc.globalCompositeOperation = 'destination-in';
        const ir = Math.min(tw, th) * 0.3;
        const or = Math.max(tw, th) * 0.5;
        const g = tc.createRadialGradient(tw / 2, th / 2, ir, tw / 2, th / 2, or);
        g.addColorStop(0, 'rgba(255,255,255,1)');
        g.addColorStop(1, 'rgba(255,255,255,0)');
        tc.fillStyle = g;
        tc.fillRect(0, 0, tw, th);

        ctx.globalAlpha = 0.88;
        ctx.drawImage(tmp, cx - tw / 2, cy - th / 2);
        ctx.globalAlpha = 1.0;
    }

    async function pickFace(file) {
        const img = new Image();
        img.src = URL.createObjectURL(file);
        await new Promise(r => img.onload = r);

        let crop = { x: 0, y: 0, w: img.width, h: img.height };
        try {
            await landmarker.setOptions({ runningMode: 'IMAGE' });
            const res = landmarker.detect(img);
            await landmarker.setOptions({ runningMode: 'VIDEO' });
            lastTime = -1;

            if (res.faceLandmarks && res.faceLandmarks.length > 0) {
                const lms = res.faceLandmarks[0];
                let lx = 1, ly = 1, hx = 0, hy = 0;
                for (const l of lms) {
                    if (l.x < lx) lx = l.x; if (l.y < ly) ly = l.y;
                    if (l.x > hx) hx = l.x; if (l.y > hy) hy = l.y;
                }
                const px = (hx - lx) * 0.35;
                const py = (hy - ly) * 0.5;
                lx = Math.max(0, lx - px); ly = Math.max(0, ly - py);
                hx = Math.min(1, hx + px); hy = Math.min(1, hy + py);
                crop = { x: lx * img.width, y: ly * img.height, w: (hx - lx) * img.width, h: (hy - ly) * img.height };
            }
        } catch (_) {
            await landmarker.setOptions({ runningMode: 'VIDEO' });
            lastTime = -1;
        }

        const fc = document.createElement('canvas');
        fc.width = Math.round(crop.w); fc.height = Math.round(crop.h);
        fc.getContext('2d').drawImage(img, crop.x, crop.y, crop.w, crop.h, 0, 0, fc.width, fc.height);
        sourceFaceCanvas = fc;
        swapping = true;

        $('faceImg').src = fc.toDataURL();
        $('faceImg').style.display = 'block';
        $('facePlaceholder').style.display = 'none';
        $('selectPrompt').classList.add('hidden');
        $('clearBtn').classList.remove('hidden');
        URL.revokeObjectURL(img.src);
    }

    function clearFace() {
        sourceFaceCanvas = null;
        swapping = false;
        $('faceImg').style.display = 'none';
        $('facePlaceholder').style.display = 'block';
        $('selectPrompt').classList.remove('hidden');
        $('clearBtn').classList.add('hidden');
    }

    function capture() {
        const el = document.createElement('div');
        el.className = 'flash-overlay';
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 250);

        lastCapture = canvas.toDataURL('image/png');
        $('galleryImg').src = lastCapture;
        $('galleryImg').style.display = 'block';
        $('galleryPlaceholder').style.display = 'none';
    }

    function downloadCapture() {
        if (!lastCapture) return;
        const a = document.createElement('a');
        a.href = lastCapture;
        a.download = 'face-swap-' + Date.now() + '.png';
        a.click();
    }

    $('flipBtn').addEventListener('click', async () => {
        facing = facing === 'user' ? 'environment' : 'user';
        await openCamera();
    });
    $('clearBtn').addEventListener('click', clearFace);
    $('captureBtn').addEventListener('click', capture);
    $('facePicker').addEventListener('click', () => $('faceInput').click());
    $('selectPrompt').addEventListener('click', () => $('faceInput').click());
    $('galleryBtn').addEventListener('click', downloadCapture);
    $('faceInput').addEventListener('change', e => {
        if (e.target.files[0]) pickFace(e.target.files[0]);
        e.target.value = '';
    });

    boot();
</script>
</body>
</html>
